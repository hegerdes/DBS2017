<?php

namespace OpiumBundle\Repository;

use Doctrine\ORM\EntityRepository;
use OpiumBundle\Entity\User;
use Doctrine\ORM\Query\Expr\Join;

/**
 * ExamRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ExamRepository extends EntityRepository
{
    public function findBySemesterId($semester, $user)
    {
        $qb= $this->createQueryBuilder('es');
        return $qb
            ->addSelect('s')
            ->addSelect('e')
            ->addSelect('r')
            ->addSelect('b')
            ->addSelect('ep')
            ->leftJoin('es.examParticipations', 'ep' , Join::WITH, $qb->expr()->eq('ep.student', ':user'))
            ->Join('es.room','r')
            ->Join('r.building','b')
            ->Join('es.examiner', 'e')
            ->Join('es.semester','s')
            ->where('es.semester = :SemID')
            ->setParameter('SemID', $semester->getID())
            ->setParameter('user', $user)
            ->orderBy('es.date', 'ASC')
            ->getQuery()
            ->getResult();
    }

    public function findEnrolledExamsByUser($user)
    {
        $qb = $this->createQueryBuilder('es');
        return $qb
            ->addSelect('r')
            ->addSelect('b')
            ->addSelect('s')
            ->addSelect('ep')
            ->addSelect('e')
            ->innerJoin('es.examiner', 'e')
            ->join('es.semester', 's')
            ->leftJoin('es.room', 'r')
            ->join('r.building', 'b')
            ->leftJoin('es.examParticipations', 'ep' , Join::WITH, $qb->expr()->eq('ep.student', ':user'))
            ->where('ep.status = :StatID')
            ->setParameter('user',$user->getId())
            ->setParameter('StatID', 1)
            ->getQuery()
            ->getResult();
    }


    public function findResultsExamsByUser($user)
    {
        $qb = $this->createQueryBuilder('es');
        return $qb
            ->addSelect('s')
            ->addSelect('ep')
            ->join('es.semester', 's')
            ->leftJoin('es.examParticipations', 'ep' , Join::WITH, $qb->expr()->eq('ep.student', ':user'))
            ->where('ep.status = :StatID1')
            ->orWhere('ep.status = :StatID2')
            ->setParameter('user',$user->getId())
            ->setParameter('StatID1', 2)
            ->setParameter('StatID2', 3)
            ->getQuery()
            ->getResult();
    }

    public function findByExaminerId(User $user)
    {
        $qb = $this->createQueryBuilder('e');
        return $qb
            ->addSelect('r')
            ->addSelect('b')
            ->addSelect('s')
            ->join('e.semester', 's')
            ->leftJoin('e.room', 'r')
            ->join('r.building', 'b')
            ->where($qb->expr()->eq('e.examiner', ':id'))
            ->setParameter('id', $user->getId())
            ->getQuery()
            ->getResult();
    }
}
